#!/bin/bash

RVC_DATA_DIR=/opt/rvc.dist
RVC_INST_DIR=/opt/rvc

RVD_PLIST_FILE=com.ribose.rvd.plist

# copy installation files
mkdir -p $RVC_INST_DIR

mkdir -p $RVC_INST_DIR/bin
mkdir -p $RVC_INST_DIR/etc
mkdir -p $RVC_INST_DIR/etc/vpn.d
mkdir -p $RVC_INST_DIR/sbin

cp $RVC_DATA_DIR/bin/rvc $RVC_INST_DIR/bin/
cp $RVC_DATA_DIR/bin/dns_util.sh $RVC_INST_DIR/bin/

cp $RVC_DATA_DIR/etc/rvd.json $RVC_INST_DIR/etc/

cp $RVC_DATA_DIR/sbin/rvd $RVC_INST_DIR/sbin/

# set owner and permission
chown -R root:wheel $RVC_INST_DIR/bin/rvc
chown -R root:wheel $RVC_INST_DIR/bin/dns_util.sh
chown -R root:wheel $RVC_INST_DIR/sbin/rvd

chown -R root:wheel $RVC_INST_DIR/etc/rvd.json
chmod 600 $RVC_INST_DIR/etc/rvd.json

# install and start rvd daemon
cp $RVC_DATA_DIR/var/plist/$RVD_PLIST_FILE /Library/LaunchDaemons/

chown -R root:wheel /Library/LaunchDaemons/$RVD_PLIST_FILE
chmod 644 /Library/LaunchDaemons/$RVD_PLIST_FILE

launchctl load /Library/LaunchDaemons/$RVD_PLIST_FILE

rm -rf $RVC_DATA_DIR

exit 0
